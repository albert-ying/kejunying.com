<!DOCTYPE html>
<html><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta name="description" content="//localhost:1313/">
    <meta name="keywords" content="personal, science">

    <meta property="og:site_name" content="Kejun Albert Ying">
    <meta property="og:title" content="Kejun Albert Ying">
    <meta property="og:description" content="How I Make QQ Plots Using ggplot">
    <meta property="og:type" content="website">
    <meta property="og:url" content="//localhost:1313/blog/how-i-make-qq-plots-using-ggplot/">
    <meta property="og:image" content="//localhost:1313/">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="//localhost:1313/blog/how-i-make-qq-plots-using-ggplot/">
    <meta name="twitter:image" content="//localhost:1313/">

    
    <link rel="stylesheet" type="text/css" href="//localhost:1313/css/style.css">
    
    
    
        
        <link rel="stylesheet" href="/custom_style.css" integrity="">
    

    <link rel="stylesheet" href="https://use.typekit.net/jxt2fnp.css"> 
    <link rel="stylesheet" href="https://use.typekit.net/uwd7war.css"> 
    <link href="https://fonts.cdnfonts.com/css/cooper-hewitt" rel="stylesheet">
    
    
        <meta name="description" content="Kejun (Albert) Ying&#39;s personal website">
    

    
        
            <link rel="shortcut icon" href="/Albert_headshot.jpg">
        
    

    
    
    
    
    
    <title>how i make qq plots using ggplot | kejun albert ying</title>
</head><body><div id="top-stripe"></div><div id="content">

    <div class="article-nav-outer">
        <div class="article-nav-inner">
            <a class="internal" hyphens="none" href='/blog'>← back to blog</a>
        </div>
    </div>

<h2 class="article-title">How I Make QQ Plots Using ggplot</h2>
<div id="doc">
    <div class="hanging-subtitle">
        
                
        
            
                <p>10 April 2020</p>
            
        
    </div>
<h2 id="introduction">Introduction</h2>
<p>Whenever I show my colleagues in the genetics group my results, the first things they say are &ldquo;<em>can you show me the Manhattan plots?</em>&rdquo; and &ldquo;<em>can you show me the QQ plots?</em>&rdquo;. I covered how to make Manhattan plots in ggplot before (click <a href="https://danielroelfs.com/blog/how-i-create-manhattan-plots-using-ggplot/">here</a> for a link. But now I want to go through how I make QQ plots. I&rsquo;m aware that there&rsquo;s a number of packages available that offer this funcionality, but I feel they&rsquo;re for the most part a bit limiting compared to making the plot yourself using the <code>{ggplot2}</code> package. Another advantage I found of creating QQ plots myself, is that I got a better understanding of how GWAS summary statistics are projected on the QQ plot, and thus I got a better understanding of QQ plots. For this process, I&rsquo;ll use the <code>{tidyverse}</code> package (which includes <code>{ggplot2}</code>) for all operations, the <code>{ggtext}</code> package for some fancy plot labels, and the <code>{normentR}</code> package to simulate some summary statistics and get some of my preferred color palettes. The code to calculate the confidence interval is based on code from Kamil Slowikowski (click <a href="https://gist.github.com/slowkow/9041570">here</a> to go to the Gist).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(tidyverse)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(ggtext)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(normentR)
</span></span></code></pre></div><h2 id="import-data-into-r">Import data into R</h2>
<p>First we&rsquo;ll simulate some summary statistics data. We can do this using the <code>simulateGWAS()</code> function in the <code>{normentR}</code> package for now. If you have summary statistics ready, you can load it in and use that instead.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1994</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sumstats_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">simulateGWAS</span>(nSNPs <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e6</span>, nSigCols <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">|&gt;</span>
</span></span><span style="display:flex;"><span>  janitor<span style="color:#f92672">::</span><span style="color:#a6e22e">clean_names</span>()
</span></span></code></pre></div><pre><code>GENERATING SIMULATED GWAS DATASET
1. Generating random rs IDs
2. Generate list of N per SNP
3. Generating BETA
4. Generating SE
5. Generating R^2
6. Generating T-values
7. Generating P-values
8. Adding significant column in chromosome 8
DONE!
</code></pre>
<p>Now we have a data frame called <code>sumstats_data</code> that contains a simulated GWAS summary statistic dataset. Note that I only generated a small number of SNPs. The QQ plot can take quite a while to generate if there&rsquo;s a lot of SNPs in the file. QQ plots require only the p-values, but we&rsquo;ll keep the entire data frame because you might need this data frame at some point later on.</p>
<h2 id="preparing-the-data">Preparing the data</h2>
<p>First I&rsquo;ll specify two variables, just to make the code later somehwat cleaner. I&rsquo;ll want to plot an area indicating the confidence interval, so we specify the confidence interval (e.g. 95%) and the number of SNPs (which is just the length of your <code>sumstats_data</code> data frame)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>ci <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0.95</span>
</span></span><span style="display:flex;"><span>n_snps <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">nrow</span>(sumstats_data)
</span></span></code></pre></div><p>Next, we&rsquo;ll create a data frame that has all the data we need for the plot. We&rsquo;ll call that data frame <code>plotdata</code>. We initiate a data frame with four columns. The first column is the observed p-values, sorted in decreasing order, and then -log<sub>10</sub> transformed. So then the SNPs with the lowest p-values will have the highest value. These SNPs will end up on the right side of the figure later. Based on this sorted vector, we can also generate the expected vector of log transformed p-values. We could do this manually, but I much prefer to use one of the (somewhat obscure but very useful) base functions in R called <code>ppoints()</code>. This generates the sequence of probabilities based on the input vector. In this case, we&rsquo;ll input just the number of SNPs.
Since we also want to plot the confidence interval, we&rsquo;ll have to calculate the upper and lower limits of the confidence interval at each point. For this we&rsquo;ll use another base function called <code>qbeta()</code>. This generates the <code>$\beta$</code> distribution for a given probabily value or range of values. For the lower half of the confidence interval, we&rsquo;ll take 1 (i.e. the null line) minus the confidence interval (<code>0.95</code>), and since this is only half of the interval, we&rsquo;ll divide that value by 2. We&rsquo;ll do the same for the upper half of the confidence interval, except not it&rsquo;s 1 plus the confidence interval. For both the upper and lower interval, we&rsquo;ll supply a vector from 1 to the number of SNPs in your data frame and then also the reverse. These two vectors will be the parameters of the <code>$\beta$</code> distribution. The output from all the functions below are the same length as the number of SNPs in your original data frame.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>plotdata <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
</span></span><span style="display:flex;"><span>  observed <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">log10</span>(<span style="color:#a6e22e">sort</span>(sumstats_data<span style="color:#f92672">$</span>p)),
</span></span><span style="display:flex;"><span>  expected <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">log10</span>(<span style="color:#a6e22e">ppoints</span>(n_snps)),
</span></span><span style="display:flex;"><span>  clower <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">log10</span>(<span style="color:#a6e22e">qbeta</span>(
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> ci) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>    shape1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">seq</span>(n_snps),
</span></span><span style="display:flex;"><span>    shape2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">rev</span>(<span style="color:#a6e22e">seq</span>(n_snps))
</span></span><span style="display:flex;"><span>  )),
</span></span><span style="display:flex;"><span>  cupper <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">log10</span>(<span style="color:#a6e22e">qbeta</span>(
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> ci) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>    shape1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">seq</span>(n_snps),
</span></span><span style="display:flex;"><span>    shape2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">rev</span>(<span style="color:#a6e22e">seq</span>(n_snps))
</span></span><span style="display:flex;"><span>  ))
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Now we have a data frame that contains all the information we need for plotting. We have the log-tranformed observed p-values, the expected values, and the lower and upper bounds for the 95% confidence interval. Before we move on to plotting, we can do another step that makes our lives later a bit easier.</p>
<p>Since the majority of SNPs have a p-value that&rsquo;s between 1 and 0.01, plotting all these individual SNPs is unnecessary. Similar to what one would do in a Manhattan plot, we&rsquo;re going to filter out a large number of SNPs that have a p-value higher than 0.01. Recall that the -log<sub>10</sub> of 0.01 is equal to 2, so we&rsquo;re going to take a subset of all expected values equal to or lower than 2. If this step causes some issue due to inflation etc., it will be easily visible in the plot later.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>plotdata_sub <span style="color:#f92672">&lt;-</span> plotdata <span style="color:#f92672">|&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">filter</span>(expected <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">|&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sample_frac</span>(<span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plotdata_sup <span style="color:#f92672">&lt;-</span> plotdata <span style="color:#f92672">|&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">filter</span>(expected <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plotdata_small <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">bind_rows</span>(plotdata_sub, plotdata_sup)
</span></span></code></pre></div><p>Now we have a much smaller data frame, which should make plotting a lot faster!</p>
<h2 id="plotting-the-data">Plotting the data</h2>
<p>Let&rsquo;s make a plot! We want the expected values on the x-axis, and the observed values on the y-axis. Then I&rsquo;ll make a <code>geom_ribbon()</code> layer with the upper and lower bounds of the confidence interval. Now, there&rsquo;s a few options. Some people prefer to see individual points (with <code>geom_point()</code>), but if you have a million SNPs, I don&rsquo;t think this always makes much sense. You can also use <code>geom_line()</code>, but I especially prefer <code>geom_step()</code>. This function creates a line between the dots in a stepwise manner, so strictly speaking there are no diagonal lines (but with many points in a region, it may look like a diagonal line). There&rsquo;s two options for the direction of the <code>geom_step()</code> function, to go from a point to the next first in vertical direction and then horizontal direction is <code>&quot;vh&quot;</code>, the other way around is denoted by <code>&quot;hv&quot;</code>. What is most suitable for your plot depends on what you want to look at. I&rsquo;d recommend to be conservative, so if you&rsquo;re trying to assess inflation, go for <code>&quot;vh&quot;</code>, which will visually bias the curve upwards. If you&rsquo;re looking only at the quality of genetic signal in your GWAS, then go for <code>&quot;hv&quot;</code>, since that will visually bias the curve to be closer to the null line. If you&rsquo;re not sure, then just go for <code>geom_line()</code>.</p>
<p>When there is no signal in your GWAS, the expected and observed p-values should overlap perfectly. In that case there&rsquo;ll be a correlation of exactly 1. This is our reference value. In order to indicate this null-line, we can add a line with an intersect at 0 and a slope of 1 with the <code>geom_abline()</code> function. This <code>geom_abline()</code> will plot a line that exceeds the observed values. I prefer to use a <code>geom_segment()</code> so that I can specify the range of the line. I select the largest expected x- and y-value and plot a line from (0,0) to that point, which will perfectly correspond to a line with a slope of 1. Your line with observed p-values should never go below this null line. If it does, it means that the p-values that you measured are higher than could reasonably be expected under a null distrbution.</p>
<p>We&rsquo;ll also add some labels written in Markdown (that will be parsed with the <code>element_markdown()</code> function from the <code>{ggtext}</code> package. I&rsquo;ll add my preferred theme (<code>theme_norment()</code>) which looks a lot like the <code>theme_minimal()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>qqplot <span style="color:#f92672">&lt;-</span> plotdata_small <span style="color:#f92672">|&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> expected, y <span style="color:#f92672">=</span> observed)) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_ribbon</span>(<span style="color:#a6e22e">aes</span>(ymax <span style="color:#f92672">=</span> cupper, ymin <span style="color:#f92672">=</span> clower),
</span></span><span style="display:flex;"><span>    fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey30&#34;</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>  ) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_step</span>(
</span></span><span style="display:flex;"><span>    color <span style="color:#f92672">=</span> norment_colors[[<span style="color:#e6db74">&#34;purple&#34;</span>]],
</span></span><span style="display:flex;"><span>    linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.1</span>, direction <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vh&#34;</span>
</span></span><span style="display:flex;"><span>  ) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_segment</span>(
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> . <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(expected <span style="color:#f92672">==</span> <span style="color:#a6e22e">max</span>(expected)),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, xend <span style="color:#f92672">=</span> expected, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, yend <span style="color:#f92672">=</span> expected),
</span></span><span style="display:flex;"><span>    linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.25</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span>,
</span></span><span style="display:flex;"><span>    color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey30&#34;</span>, lineend <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;round&#34;</span>
</span></span><span style="display:flex;"><span>  ) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">labs</span>(
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_glue</span>(<span style="color:#e6db74">&#34;Expected -log&lt;sub&gt;10&lt;/sub&gt;(P)&#34;</span>),
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_glue</span>(<span style="color:#e6db74">&#34;Observed -log&lt;sub&gt;10&lt;/sub&gt;(P)&#34;</span>)
</span></span><span style="display:flex;"><span>  ) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">theme_norment</span>() <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">theme</span>(
</span></span><span style="display:flex;"><span>    axis.title.x <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_markdown</span>(),
</span></span><span style="display:flex;"><span>    axis.title.y <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_markdown</span>()
</span></span><span style="display:flex;"><span>  )
</span></span></code></pre></div><p>I must issue a small warning now, since these GWAS files can be quite large, plotting all these values can take quite some time, so if you&rsquo;re working on an older MacBook Air (like I am) you may have to be a little patient. Let&rsquo;s see what the plot looks like.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(qqplot)
</span></span></code></pre></div><img src="index.markdown_strict_files/figure-markdown_strict/print-plot-1.png" width="576" />
<p>Now we have our QQ plot. We see that our (simulated) GWAS dataset has a very nice signal! I&rsquo;d be dissapointed if it didn&rsquo;t since I coded it to be this way. It is possible to annotate this plot further or to add multiple lines depending on thresholds (I&rsquo;m thinking about conditional/conjunctional FDR thresholds for instance). Good luck!</p>
<p>The code above was adapted from a script by Kamil Slowikowski (click <a href="https://gist.github.com/slowkow/9041570">here</a> to go to the Gist). See also the <code>{qqplotr}</code> package for extended functionality around QQ plots in ggplot (click <a href="https://github.com/aloy/qqplotr">here</a> to go to the repository).</p>

</div>

        </div>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/foundation.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
<script>
  hljs.highlightAll();
</script>


<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>
  MathJax = {
      tex: {
        inlineMath: [ ['$','$'] ]
      }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"></script>


<script src="https://unpkg.com/feather-icons"></script>
<script>
  feather.replace()
</script>

<div id="nav-border" class="container">
    
    <div class="nav-outer">
        <div class="nav-inner">
            
                
                    
                        <a class="internal" hyphens="none" href="/">
                            
                            Home
                        </a>
                    
                
                    
                        <a class="internal" hyphens="none" href="/blog">
                            
                            Blog
                        </a>
                    
                
                    
                
                    
                        <a class="internal" hyphens="none" href="/publications">
                            
                            Publications
                        </a>
                    
                
                    
                        <a class="internal" hyphens="none" href="/cv">
                            
                            CV
                        </a>
                    
                
                    
                        <a class="internal" hyphens="none" href="/about">
                            
                            About
                        </a>
                    
                
            
        </div>
    </div>
    
</div>

</body>
</html>
